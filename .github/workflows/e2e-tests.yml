name: E2E Tests with Cypress

on:
  workflow_dispatch:
    inputs:
      skip_build:
        description: 'Skip building images (use existing images from GCR)'
        required: false
        type: boolean
        default: false

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  BACKEND_IMAGE: apartment-backend
  FRONTEND_IMAGE: apartment-frontend

jobs:
  build-backend:
    name: Build Backend for E2E
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_build }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Build Backend Image
        working-directory: ./backend
        run: |
          echo "Building backend image with SHA: ${{ github.sha }}"
          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_IMAGE_TAG=${{ github.sha }} \
            --async \
            --format="value(id)")
          
          echo "Build ID: $BUILD_ID"
          
          for i in {1..30}; do
            STATUS=$(gcloud builds describe $BUILD_ID --format="value(status)" 2>/dev/null || echo "QUEUED")
            echo "Build status: $STATUS"
            
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "âœ… Backend image built successfully!"
              exit 0
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "âŒ Build failed with status: $STATUS"
              gcloud builds log $BUILD_ID
              exit 1
            fi
            
            SLEEP_TIME=$((i * 10))
            if [ $SLEEP_TIME -gt 60 ]; then SLEEP_TIME=60; fi
            sleep $SLEEP_TIME
          done
  
  build-frontend:
    name: Build Frontend for E2E
    runs-on: ubuntu-latest
    if: ${{ !inputs.skip_build }}
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Build Frontend Image
        working-directory: ./frontend
        run: |
          echo "Building frontend image with SHA: ${{ github.sha }}"
          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_IMAGE_TAG=${{ github.sha }} \
            --async \
            --format="value(id)")
          
          echo "Build ID: $BUILD_ID"
          
          for i in {1..30}; do
            STATUS=$(gcloud builds describe $BUILD_ID --format="value(status)" 2>/dev/null || echo "QUEUED")
            echo "Build status: $STATUS"
            
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "âœ… Frontend image built successfully!"
              exit 0
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "âŒ Build failed with status: $STATUS"
              gcloud builds log $BUILD_ID
              exit 1
            fi
            
            SLEEP_TIME=$((i * 10))
            if [ $SLEEP_TIME -gt 60 ]; then SLEEP_TIME=60; fi
            sleep $SLEEP_TIME
          done

  check-builds:
    runs-on: ubuntu-latest
    name: Check if builds are ready
    needs: [build-backend, build-frontend]
    if: always()
    outputs:
      backend_ready: ${{ steps.check.outputs.backend_ready }}
      frontend_ready: ${{ steps.check.outputs.frontend_ready }}
    steps:
      - name: Check build status
        id: check
        run: |
          if [ "${{ needs.build-backend.result }}" = "success" ] || [ "${{ needs.build-backend.result }}" = "skipped" ]; then
            echo "backend_ready=true" >> $GITHUB_OUTPUT
          else
            echo "backend_ready=false" >> $GITHUB_OUTPUT
          fi
          
          if [ "${{ needs.build-frontend.result }}" = "success" ] || [ "${{ needs.build-frontend.result }}" = "skipped" ]; then
            echo "frontend_ready=true" >> $GITHUB_OUTPUT
          else
            echo "frontend_ready=false" >> $GITHUB_OUTPUT
          fi
  
  cypress-e2e:
    runs-on: ubuntu-latest
    name: Run Cypress E2E Tests
    needs: check-builds
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Node.js for Cypress
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      # 3. Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 4. Setup gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # 5. Configure Docker for GCR
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      # 6. Pull latest Docker images
      - name: Pull Docker Images from GCR
        run: |
          echo "Pulling latest images from GCR..."
          
          BACKEND_MISSING=false
          FRONTEND_MISSING=false
          
          # Pull backend image
          if docker pull gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}; then
            echo "âœ… Found backend image with SHA: ${{ github.sha }}"
            docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
              gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:test
          elif docker pull gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:latest; then
            echo "âš ï¸ SHA image not found, using latest"
            docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:latest \
              gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:test
          else
            echo "âŒ No backend image found in GCR"
            BACKEND_MISSING=true
          fi
          
          # Pull frontend image
          if docker pull gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}; then
            echo "âœ… Found frontend image with SHA: ${{ github.sha }}"
            docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }} \
              gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:test
          elif docker pull gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:latest; then
            echo "âš ï¸ SHA image not found, using latest"
            docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:latest \
              gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:test
          else
            echo "âŒ No frontend image found in GCR"
            FRONTEND_MISSING=true
          fi
          
          # Pull MySQL
          docker pull mysql:8.0
          
          # Check if any images are missing
          if [ "$BACKEND_MISSING" = "true" ] || [ "$FRONTEND_MISSING" = "true" ]; then
            echo "âŒ Required images not found. Please run build workflow first."
            exit 1
          fi
          
          echo "âœ… All images pulled successfully"

      # 7. Install Cypress dependencies
      - name: Install Cypress dependencies
        working-directory: ./frontend
        run: npm ci

      # 8. Create test environment file
      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          GCP_PROJECT_ID=${{ env.PROJECT_ID }}
          IMAGE_TAG=test
          MYSQL_ROOT_PASSWORD=root123
          MYSQL_DATABASE=apartment_db
          SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/apartment_db
          SPRING_DATASOURCE_USERNAME=root
          SPRING_DATASOURCE_PASSWORD=root123
          VITE_API_URL=http://localhost:8080
          EOF

      # 9. Start Application Stack with Docker Compose
      - name: Start Application Stack
        run: |
          echo "Starting services with Docker Compose..."
          docker compose -f docker-compose.test.yml up -d
          
          echo "Waiting for MySQL to be ready..."
          timeout 120s bash -c 'until docker compose -f docker-compose.test.yml exec -T mysql mysqladmin ping -h localhost --silent; do echo "Waiting for MySQL..."; sleep 5; done'
          echo "âœ… MySQL is ready"
          
          echo "Waiting a bit for backend to initialize..."
          sleep 10
          
          echo "=== Backend Container Status ==="
          docker compose -f docker-compose.test.yml ps backend
          
          echo "=== Checking if backend is still running ==="
          if ! docker compose -f docker-compose.test.yml ps backend | grep -q "Up"; then
            echo "âŒ Backend container crashed! Showing full logs:"
            docker compose -f docker-compose.test.yml logs backend
            echo ""
            echo "=== Backend Container Inspect ==="
            docker inspect apartment-test-backend --format='{{.State.ExitCode}}: {{.State.Error}}'
            exit 1
          fi
          
          echo "Waiting for Backend to be ready..."
          timeout 120s bash -c 'until curl -f http://localhost:8080/api/health 2>/dev/null; do echo "Waiting for Backend..."; sleep 5; done' || {
            echo "âŒ Backend failed to start. Showing logs:"
            docker compose -f docker-compose.test.yml logs backend
            exit 1
          }
          echo "âœ… Backend is ready"
          
          echo "Waiting for Frontend to be ready..."
          timeout 60s bash -c 'until curl -f http://localhost:5173 2>/dev/null; do echo "Waiting for Frontend..."; sleep 3; done'
          echo "âœ… Frontend is ready"
          
          echo "ðŸŽ‰ All services are up and running!"

      # 10. Display running containers for debugging
      - name: Show running containers
        if: always()
        run: docker compose -f docker-compose.test.yml ps

      # 11. Run Cypress E2E tests
      - name: Run Cypress Tests
        working-directory: ./frontend
        run: |
          echo "ðŸ§ª Running Cypress E2E tests..."
          npx cypress run --config baseUrl=http://localhost:80

      # 12. Upload test videos
      - name: Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: frontend/cypress/videos/
          retention-days: 7

      # 13. Upload test screenshots (failures only)
      - name: Upload Cypress Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: frontend/cypress/screenshots/
          retention-days: 7
          if-no-files-found: ignore

      # 14. Cleanup test environment
      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

      # 15. Test Summary
      - name: Test Summary
        if: always()
        run: |
          echo "=== E2E Test Results ==="
          echo "Status: ${{ job.status }}"
          echo "Backend Image: gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}"
          echo "Frontend Image: gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}"

