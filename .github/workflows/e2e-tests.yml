name: E2E Tests with Cypress

on:
  workflow_run:
    workflows: ["Backend CI - Build, Test & Push", "Frontend CI - Build, Test & Push"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  BACKEND_IMAGE: apartment-backend
  FRONTEND_IMAGE: apartment-frontend

jobs:
  cypress-e2e:
    runs-on: ubuntu-latest
    name: Run Cypress E2E Tests
    
    # Only run if both backend and frontend builds succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      # 1. Checkout code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Set up Node.js for Cypress
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      # 3. Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 4. Setup gcloud CLI
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # 5. Configure Docker for GCR
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker

      # 6. Pull latest Docker images
      - name: Pull Docker Images from GCR
        run: |
          echo "Pulling latest images from GCR..."
          # Try to pull with commit SHA first (from recent build)
          if docker pull gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}; then
            docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
              gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:test
          else
            echo "âš ï¸ Image with SHA not found, using latest"
            docker pull gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:latest
            docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:latest \
              gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:test
          fi
          
          if docker pull gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}; then
            docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }} \
              gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:test
          else
            echo "âš ï¸ Image with SHA not found, using latest"
            docker pull gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:latest
            docker tag gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:latest \
              gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:test
          fi
          
          docker pull mysql:8.0
          
          echo "âœ… All images pulled successfully"

      # 7. Install Cypress dependencies
      - name: Install Cypress dependencies
        working-directory: ./frontend
        run: npm ci

      # 8. Create test environment file
      - name: Create .env file for testing
        run: |
          cat > .env << EOF
          GCP_PROJECT_ID=${{ env.PROJECT_ID }}
          IMAGE_TAG=test
          MYSQL_ROOT_PASSWORD=root123
          MYSQL_DATABASE=apartment_db
          SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/apartment_db
          SPRING_DATASOURCE_USERNAME=root
          SPRING_DATASOURCE_PASSWORD=root123
          VITE_API_URL=http://localhost:8080
          EOF

      # 9. Start Application Stack with Docker Compose
      - name: Start Application Stack
        run: |
          echo "Starting services with Docker Compose..."
          docker compose -f docker-compose.test.yml up -d
          
          echo "Waiting for MySQL to be ready..."
          timeout 120s bash -c 'until docker compose -f docker-compose.test.yml exec -T mysql mysqladmin ping -h localhost --silent; do echo "Waiting for MySQL..."; sleep 5; done'
          echo "âœ… MySQL is ready"
          
          echo "Waiting a bit for backend to start..."
          sleep 10
          
          echo "=== Backend Container Status ==="
          docker compose -f docker-compose.test.yml ps backend
          
          echo "=== Backend Logs ==="
          docker compose -f docker-compose.test.yml logs backend
          
          echo "Waiting for Backend to be ready..."
          timeout 120s bash -c 'until curl -f http://localhost:8080/health 2>/dev/null; do echo "Waiting for Backend..."; sleep 5; done' || {
            echo "âŒ Backend failed to start. Showing logs:"
            docker compose -f docker-compose.test.yml logs backend
            exit 1
          }
          echo "âœ… Backend is ready"
          
          echo "Waiting for Frontend to be ready..."
          timeout 60s bash -c 'until curl -f http://localhost:5173 2>/dev/null; do echo "Waiting for Frontend..."; sleep 3; done'
          echo "âœ… Frontend is ready"
          
          echo "ðŸŽ‰ All services are up and running!"

      # 10. Display running containers for debugging
      - name: Show running containers
        if: always()
        run: docker compose -f docker-compose.test.yml ps

      # 11. Run Cypress E2E tests
      - name: Run Cypress Tests
        working-directory: ./frontend
        run: |
          echo "ðŸ§ª Running Cypress E2E tests..."
          npx cypress run --config baseUrl=http://localhost:80

      # 12. Upload test videos
      - name: Upload Cypress Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: frontend/cypress/videos/
          retention-days: 7

      # 13. Upload test screenshots (failures only)
      - name: Upload Cypress Screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: frontend/cypress/screenshots/
          retention-days: 7
          if-no-files-found: ignore

      # 14. Cleanup test environment
      - name: Cleanup
        if: always()
        run: docker compose -f docker-compose.test.yml down -v

      # 15. Test Summary
      - name: Test Summary
        if: always()
        run: |
          echo "=== E2E Test Results ==="
          echo "Status: ${{ job.status }}"
          echo "Backend Image: gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }}"
          echo "Frontend Image: gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }}"

