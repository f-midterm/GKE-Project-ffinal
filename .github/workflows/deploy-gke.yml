name: Deploy to GKE

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - 'k8s-gcp/**'
      - '.github/workflows/deploy-gke.yml'
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}
  NAMESPACE: beliv-apartment
  BACKEND_IMAGE: apartment-backend
  FRONTEND_IMAGE: apartment-frontend

jobs:
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Build Backend Image
        working-directory: ./backend
        run: |
          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_IMAGE_TAG=${{ github.sha }} \
            --async \
            --format="value(id)")
          
          echo "Build ID: $BUILD_ID"
          echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          
          for i in {1..30}; do
            STATUS=$(gcloud builds describe $BUILD_ID --format="value(status)" 2>/dev/null || echo "QUEUED")
            echo "Build status: $STATUS"
            
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "✅ Backend image built successfully!"
              exit 0
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "❌ Build failed with status: $STATUS"
              gcloud builds log $BUILD_ID
              exit 1
            fi
            
            SLEEP_TIME=$((i * 10))
            if [ $SLEEP_TIME -gt 60 ]; then SLEEP_TIME=60; fi
            sleep $SLEEP_TIME
          done
  
  build-frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}
      
      - name: Configure Docker for GCR
        run: gcloud auth configure-docker
      
      - name: Build Frontend Image
        working-directory: ./frontend
        run: |
          BUILD_ID=$(gcloud builds submit \
            --config=cloudbuild.yaml \
            --substitutions=_IMAGE_TAG=${{ github.sha }} \
            --async \
            --format="value(id)")
          
          echo "Build ID: $BUILD_ID"
          
          for i in {1..30}; do
            STATUS=$(gcloud builds describe $BUILD_ID --format="value(status)" 2>/dev/null || echo "QUEUED")
            echo "Build status: $STATUS"
            
            if [ "$STATUS" = "SUCCESS" ]; then
              echo "✅ Frontend image built successfully!"
              exit 0
            elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
              echo "❌ Build failed with status: $STATUS"
              gcloud builds log $BUILD_ID
              exit 1
            fi
            
            SLEEP_TIME=$((i * 10))
            if [ $SLEEP_TIME -gt 60 ]; then SLEEP_TIME=60; fi
            sleep $SLEEP_TIME
          done
  
  deploy:
    name: Deploy to GKE
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    if: always() && (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped') && (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped')
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    # ============================================
    # Step 1: Checkout Code
    # ============================================
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ============================================
    # Step 2: Authenticate to Google Cloud
    # ============================================
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    # ============================================
    # Step 3: Setup gcloud CLI
    # ============================================
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    # ============================================
    # Step 4: Configure Docker for GCR
    # ============================================
    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker
    
    # ============================================
    # Step 5: Get GKE Credentials
    # ============================================
    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}
    
    # ============================================
    # Step 6: Apply ConfigMap and Secret with GitHub Secrets
    # ============================================
    - name: Update Backend ConfigMap and Secret
      working-directory: ./k8s-gcp/backend
      env:
        DEFAULT_ADMIN_USERNAME: ${{ secrets.DEFAULT_ADMIN_USERNAME }}
        DEFAULT_ADMIN_EMAIL: ${{ secrets.DEFAULT_ADMIN_EMAIL }}
        DEFAULT_VILLAGER_USERNAME: ${{ secrets.DEFAULT_VILLAGER_USERNAME }}
        DEFAULT_VILLAGER_EMAIL: ${{ secrets.DEFAULT_VILLAGER_EMAIL }}
        DEFAULT_TEST_USERNAME: ${{ secrets.DEFAULT_TEST_USERNAME }}
        DEFAULT_TEST_EMAIL: ${{ secrets.DEFAULT_TEST_EMAIL }}
        DEFAULT_ADMIN_PASSWORD: ${{ secrets.DEFAULT_ADMIN_PASSWORD }}
        DEFAULT_VILLAGER_PASSWORD: ${{ secrets.DEFAULT_VILLAGER_PASSWORD }}
        DEFAULT_TEST_PASSWORD: ${{ secrets.DEFAULT_TEST_PASSWORD }}
      run: |
        echo "Applying Backend ConfigMap..."
        envsubst < configmap.yaml | kubectl apply -f -
        
        echo "Applying Backend Secret..."
        envsubst < secret.yaml | kubectl apply -f -
        
        echo "✅ Backend ConfigMap and Secret updated"
    
    - name: Update Database Secret
      working-directory: ./k8s-gcp/database
      env:
        MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        MYSQL_USERNAME: ${{ secrets.MYSQL_USERNAME }}
        MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
      run: |
        echo "Applying Database Secret..."
        envsubst < secret.yaml | kubectl apply -f -
        
        echo "✅ Database Secret updated"
    
    # ============================================
    # Step 7: Deploy to GKE
    # ============================================
    - name: Deploy Backend
      run: |
        kubectl set image deployment/backend \
          backend=gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
          -n ${{ env.NAMESPACE }}
        
        echo "Waiting for backend deployment..."
        kubectl rollout status deployment/backend -n ${{ env.NAMESPACE }} --timeout=10m
        
        echo "Checking backend pod status..."
        kubectl get pods -n ${{ env.NAMESPACE }} -l component=backend
        
        echo "Showing backend logs..."
        kubectl logs -n ${{ env.NAMESPACE }} -l component=backend --tail=50
    
    - name: Deploy Frontend
      run: |
        kubectl set image deployment/frontend \
          frontend=gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }} \
          -n ${{ env.NAMESPACE }}
        kubectl rollout status deployment/frontend -n ${{ env.NAMESPACE }} --timeout=5m
    
    # ============================================
    # Step 7: Verify Deployment
    # ============================================
    - name: Verify Deployment
      run: |
        echo "=== Pods Status ==="
        kubectl get pods -n ${{ env.NAMESPACE }}
        
        echo -e "\n=== Backend Image ==="
        kubectl get deployment backend -n ${{ env.NAMESPACE }} \
          -o jsonpath='{.spec.template.spec.containers[0].image}'
        
        echo -e "\n=== Frontend Image ==="
        kubectl get deployment frontend -n ${{ env.NAMESPACE }} \
          -o jsonpath='{.spec.template.spec.containers[0].image}'
        
        echo -e "\n=== Deployment Complete! ==="
        echo "Commit SHA: ${{ github.sha }}"
        echo "Application URL: https://beliv.pipatpongpri.dev"

