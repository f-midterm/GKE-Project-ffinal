name: Build and Deploy to GKE

on:
  push:
    branches:
      - main
      - release/ver1/infrastructure
  workflow_dispatch:  # Manual trigger

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: ${{ secrets.GKE_CLUSTER_NAME }}
  GKE_ZONE: ${{ secrets.GKE_ZONE }}  # asia-southeast1-a
  NAMESPACE: beliv-apartment
  BACKEND_IMAGE: apartment-backend
  FRONTEND_IMAGE: apartment-frontend

jobs:
  deploy:
    name: Build and Deploy to GKE
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    steps:
    # ============================================
    # Step 1: Checkout Code
    # ============================================
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ============================================
    # Step 2: Authenticate to Google Cloud
    # ============================================
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    # ============================================
    # Step 3: Setup gcloud CLI
    # ============================================
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    # ============================================
    # Step 4: Configure Docker for GCR
    # ============================================
    - name: Configure Docker for GCR
      run: |
        gcloud auth configure-docker
    
    # ============================================
    # Step 5: Get GKE Credentials
    # ============================================
    - name: Get GKE credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: ${{ env.GKE_CLUSTER }}
        location: ${{ env.GKE_ZONE }}
    
    # ============================================
    # Step 6: Build Images with Cloud Build
    # ============================================
    - name: Build Backend Image
      run: |
        cd backend
        gcloud builds submit \
          --config=cloudbuild.yaml \
          --substitutions=_IMAGE_TAG=${{ github.sha }},_PROJECT_ID=${{ env.PROJECT_ID }} \
          --machine-type=n1-highcpu-8
    
    - name: Build Frontend Image
      run: |
        cd frontend
        gcloud builds submit \
          --config=cloudbuild.yaml \
          --substitutions=_IMAGE_TAG=${{ github.sha }},_PROJECT_ID=${{ env.PROJECT_ID }} \
          --machine-type=n1-highcpu-8
    
    # ============================================
    # Step 7: Deploy to GKE (using kubectl set image)
    # ============================================
    - name: Deploy Backend
      run: |
        kubectl set image deployment/backend \
          backend=gcr.io/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${{ github.sha }} \
          -n ${{ env.NAMESPACE }}
        kubectl rollout status deployment/backend -n ${{ env.NAMESPACE }} --timeout=5m
    
    - name: Deploy Frontend
      run: |
        kubectl set image deployment/frontend \
          frontend=gcr.io/${{ env.PROJECT_ID }}/${{ env.FRONTEND_IMAGE }}:${{ github.sha }} \
          -n ${{ env.NAMESPACE }}
        kubectl rollout status deployment/frontend -n ${{ env.NAMESPACE }} --timeout=5m
    
    # ============================================
    # Step 8: Verify Deployment
    # ============================================
    - name: Verify Deployment
      run: |
        echo "=== Pods Status ==="
        kubectl get pods -n ${{ env.NAMESPACE }}
        
        echo -e "\n=== Backend Image ==="
        kubectl get deployment backend -n ${{ env.NAMESPACE }} \
          -o jsonpath='{.spec.template.spec.containers[0].image}'
        
        echo -e "\n=== Frontend Image ==="
        kubectl get deployment frontend -n ${{ env.NAMESPACE }} \
          -o jsonpath='{.spec.template.spec.containers[0].image}'
        
        echo -e "\n=== Deployment Complete! ==="
        echo "Application URL: https://beliv.pipatpongpri.dev"
        
        echo -e "\n=== Deployment Complete! ==="
        echo "Application URL: https://beliv.pipatpongpri.dev"
