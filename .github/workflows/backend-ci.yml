name: Backend CI - Build, Test & Push

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  BACKEND_IMAGE: apartment-backend
  REGISTRY: gcr.io

jobs:
  build-and-push:
    name: Build and Push Backend
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
      image-url: ${{ steps.meta.outputs.image }}
    
    steps:
    # ============================================
    # Checkout Code
    # ============================================
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ============================================
    # Authenticate to Google Cloud
    # ============================================
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    # ============================================
    # Setup gcloud CLI
    # ============================================
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    # ============================================
    # Configure Docker for GCR
    # ============================================
    - name: Configure Docker for GCR
      run: gcloud auth configure-docker
    
    # ============================================
    # Set Image Metadata
    # ============================================
    - name: Set image metadata
      id: meta
      run: |
        IMAGE_TAG="${{ github.sha }}"
        IMAGE_URL="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${IMAGE_TAG}"
        echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "image=${IMAGE_URL}" >> $GITHUB_OUTPUT
        echo "Image will be: ${IMAGE_URL}"
    
    # ============================================
    # Build Backend with Cloud Build
    # ============================================
    - name: Build Backend Image
      working-directory: ./backend
      run: |
        gcloud builds submit \
          --config=cloudbuild.yaml \
          --substitutions=_IMAGE_TAG=${{ steps.meta.outputs.tag }} \
          --timeout=15m
    
    # ============================================
    # Verify Image
    # ============================================
    - name: Verify Image
      run: |
        echo "=== Verifying Backend Image ==="
        gcloud container images describe ${{ steps.meta.outputs.image }}
        echo "âœ… Backend image built successfully!"
        echo "Image: ${{ steps.meta.outputs.image }}"
