name: Backend CI - Build, Test & Push

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch:

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  BACKEND_IMAGE: apartment-backend
  REGISTRY: gcr.io

jobs:
  build-and-push:
    name: Build and Push Backend
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      id-token: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
      image-url: ${{ steps.meta.outputs.image }}
    
    steps:
    # ============================================
    # Checkout Code
    # ============================================
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ============================================
    # Authenticate to Google Cloud
    # ============================================
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    # ============================================
    # Setup gcloud CLI
    # ============================================
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2
      with:
        project_id: ${{ env.PROJECT_ID }}
    
    # ============================================
    # Configure Docker for GCR
    # ============================================
    - name: Configure Docker for GCR
      run: gcloud auth configure-docker
    
    # ============================================
    # Set Image Metadata
    # ============================================
    - name: Set image metadata
      id: meta
      run: |
        IMAGE_TAG="${{ github.sha }}"
        IMAGE_URL="${{ env.REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.BACKEND_IMAGE }}:${IMAGE_TAG}"
        echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
        echo "image=${IMAGE_URL}" >> $GITHUB_OUTPUT
        echo "Image will be: ${IMAGE_URL}"
    
    # ============================================
    # Build Backend with Cloud Build
    # ============================================
    - name: Build Backend Image
      working-directory: ./backend
      run: |
        BUILD_ID=$(gcloud builds submit \
          --config=cloudbuild.yaml \
          --substitutions=_IMAGE_TAG=${{ steps.meta.outputs.tag }} \
          --async \
          --format="value(id)")
        
        echo "Build ID: $BUILD_ID"
        echo "Waiting for build to complete..."
        
        # Wait with exponential backoff to avoid rate limit
        for i in {1..30}; do
          STATUS=$(gcloud builds describe $BUILD_ID --format="value(status)" 2>/dev/null || echo "QUEUED")
          echo "Build status: $STATUS"
          
          if [ "$STATUS" = "SUCCESS" ]; then
            echo "✅ Backend image built successfully!"
            echo "Image: ${{ steps.meta.outputs.image }}"
            exit 0
          elif [ "$STATUS" = "FAILURE" ] || [ "$STATUS" = "TIMEOUT" ] || [ "$STATUS" = "CANCELLED" ]; then
            echo "❌ Build failed with status: $STATUS"
            gcloud builds log $BUILD_ID
            exit 1
          fi
          
          # Exponential backoff: 10s, 20s, 30s...
          SLEEP_TIME=$((i * 10))
          if [ $SLEEP_TIME -gt 60 ]; then SLEEP_TIME=60; fi
          sleep $SLEEP_TIME
        done
        
        echo "❌ Build timeout after 15 minutes"
        exit 1
